"use strict";(()=>{var ne="/api/outfit",F="outfit:lastCoords",j="outfit:recentPlaces",T="Asia/Taipei",M="outfit:theme",I="outfit:morningBias",P="outfit:eveningBias",Y=[{name:"\u53F0\u5317\u5E02",lat:25.032969,lon:121.565418,type:"county"},{name:"\u65B0\u5317\u5E02",lat:25.016983,lon:121.462787,type:"county"},{name:"\u6843\u5712\u5E02",lat:24.993681,lon:121.3,type:"county"},{name:"\u53F0\u4E2D\u5E02",lat:24.147736,lon:120.673648,type:"county"},{name:"\u53F0\u5357\u5E02",lat:22.999728,lon:120.227027,type:"county"},{name:"\u9AD8\u96C4\u5E02",lat:22.627278,lon:120.301435,type:"county"},{name:"\u57FA\u9686\u5E02",lat:25.131723,lon:121.744652,type:"county"},{name:"\u65B0\u7AF9\u5E02",lat:24.813829,lon:120.967479,type:"county"},{name:"\u65B0\u7AF9\u7E23",lat:24.838722,lon:121.017724,type:"county"},{name:"\u82D7\u6817\u7E23",lat:24.560159,lon:120.821426,type:"county"},{name:"\u5F70\u5316\u7E23",lat:24.075305,lon:120.544822,type:"county"},{name:"\u5357\u6295\u7E23",lat:23.960998,lon:120.971863,type:"county"},{name:"\u96F2\u6797\u7E23",lat:23.709203,lon:120.431337,type:"county"},{name:"\u5609\u7FA9\u5E02",lat:23.480075,lon:120.449111,type:"county"},{name:"\u5609\u7FA9\u7E23",lat:23.451842,lon:120.255461,type:"county"},{name:"\u5C4F\u6771\u7E23",lat:22.551976,lon:120.548759,type:"county"},{name:"\u5B9C\u862D\u7E23",lat:24.702107,lon:121.73775,type:"county"},{name:"\u82B1\u84EE\u7E23",lat:23.987158,lon:121.601571,type:"county"},{name:"\u53F0\u6771\u7E23",lat:22.758587,lon:121.144605,type:"county"},{name:"\u6F8E\u6E56\u7E23",lat:23.571122,lon:119.579735,type:"county"},{name:"\u91D1\u9580\u7E23",lat:24.436331,lon:118.317089,type:"county"},{name:"\u9023\u6C5F\u7E23",lat:26.160469,lon:119.949875,type:"county"}],v=[...Y];function i(e){let t=document.getElementById(e);if(!t)throw new Error(`Missing element: ${e}`);return t}function E(e,t){i(e).textContent=t}function H(e,t,n){localStorage.setItem(F,JSON.stringify({lat:e,lon:t,name:n||"",t:Date.now()}))}function ae(){try{return JSON.parse(localStorage.getItem(F)||"null")}catch(e){return null}}function w(){try{return JSON.parse(localStorage.getItem(j)||"[]")}catch(e){return[]}}function U(e){localStorage.setItem(j,JSON.stringify(e))}function B(e){if(!e||!e.name)return;let n=w().filter(a=>a.name!==e.name);n.unshift({name:e.name,lat:e.lat,lon:e.lon}),U(n.slice(0,10))}function q(e){let t=w().filter(n=>n.name!==e);U(t),h()}function m(e){return String(e||"").replace(/\s+/g,"").toLowerCase()}function S(e){let t=String(e||"").trim();if(!t)return null;let n=m(t),a=v.find(c=>m(c.name)===n);if(a)return a;let o=v.find(c=>c.town&&m(c.town)===n);return o||v.find(c=>m(c.name).includes(n))||null}function oe(e){let t=i("timeline");t.innerHTML=(e||[]).map(n=>{let a=n.feels_like_c!=null?`${n.feels_like_c}\xB0C`:"\u2014",o=n.rain===!0?"\u6709\u96E8":n.rain===!1?"\u964D\u96E8\u4F4E":"\u96E8?";return`<div class="time-card"><div class="time-label">${n.label||n.time||""}</div><div>${X(n.wear)} ${n.wear}</div><div class="time-note">${Q(n)} \u9AD4\u611F ${a} \xB7 ${o}</div></div>`}).join("")}function D(e){let t=i("tips"),n=e&&Array.isArray(e.tips)?e.tips:[];t.innerHTML=n.length?n.map(a=>`<li>${a}</li>`).join(""):"<li>\u6C92\u6709\u984D\u5916\u63D0\u9192</li>"}function R(e){let t=i("alert");(e||[]).some(a=>a.rain===!0)?(t.textContent="\u4ECA\u5929\u6709\u660E\u986F\u964D\u96E8\u6A5F\u7387\uFF0C\u5EFA\u8B70\u5E36\u96E8\u5177\u6216\u9632\u6C34\u5916\u5C64\u3002",t.style.display="block"):(t.textContent="",t.style.display="none")}function ie(e,t){if(!e)return"";let n=new Date(`${e}T00:00:00+08:00`),a=new Intl.DateTimeFormat("zh-Hant",{weekday:"short",timeZone:t||T}).format(n);return`${e} ${a}`}function d(e){var a,o,s,c,u;if(!e||!e.ok){E("summary","\u67E5\u8A62\u5931\u6557"),E("meta",e&&e.error?e.error:""),i("periods").innerHTML="",i("timeline").innerHTML="",D(void 0),R([]);return}E("summary",((a=e.overall)==null?void 0:a.summary)||"\uFF08\u7121 overall\uFF09");let t=ie(e.date,e.timezone||T);E("meta",`${((o=e.place)==null?void 0:o.ctyName)||""}${((s=e.place)==null?void 0:s.townName)||""} ${t} ${e.timezone||T}`);let n=e.periods||[];if(i("periods").innerHTML=n.map(l=>{let L=l.rain===!0?"\u6703\u4E0B\u96E8":l.rain===!1?"\u4E0D\u592A\u6703\u4E0B\u96E8":"\u96E8\u672A\u77E5",f=l.extras&&l.extras.length?"\uFF5C"+l.extras.join("\u3001"):"",te=l.feels_like_c!=null?`\uFF08\u9AD4\u611F ${l.feels_like_c}\xB0C\uFF09`:"";return`<div style="margin-top:8px"><b>${l.label||l.time||""}</b>\uFF1A${X(l.wear)} ${l.wear} ${te}\uFF5C${Q(l)} ${L}${f}</div>`}).join(""),oe(n),D(e.overall),R(n),r&&r.name==="\u76EE\u524D\u4F4D\u7F6E"){let l=`${((c=e.place)==null?void 0:c.ctyName)||""}${((u=e.place)==null?void 0:u.townName)||""}`.trim();l&&e.location&&(r={name:l,lat:e.location.lat,lon:e.location.lon},H(r.lat,r.lon,r.name),q("\u76EE\u524D\u4F4D\u7F6E"),B(r),h(),i("placeSearch").value=r.name)}}function re(e){var u,l,L;let t=new Date,n=new Date(t.getTime()+e*864e5),a=new Intl.DateTimeFormat("en-CA",{timeZone:T,year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(n),o=(u=a.find(f=>f.type==="year"))==null?void 0:u.value,s=(l=a.find(f=>f.type==="month"))==null?void 0:l.value,c=(L=a.find(f=>f.type==="day"))==null?void 0:L.value;return`${o}-${s}-${c}`}function V(){let e=Number(localStorage.getItem(I)),t=Number(localStorage.getItem(P));return{morning:Number.isFinite(e)?e:0,evening:Number.isFinite(t)?t:0}}async function p(e,t,n){let a=re(n||0),o=V(),s=`${ne}?lat=${encodeURIComponent(e)}&lon=${encodeURIComponent(t)}&date=${encodeURIComponent(a)}&morningBias=${encodeURIComponent(o.morning)}&eveningBias=${encodeURIComponent(o.evening)}`,u=await(await fetch(s,{headers:{Accept:"application/json"}})).json();return d(u),u}var r=null,g=0;function $(e){e&&(r=e,H(e.lat,e.lon,e.name),B(e),h(),p(e.lat,e.lon,g).catch(t=>d({ok:!1,error:String(t),date:"",periods:[]})))}function h(){let e=i("recentPlaces"),t=w();if(!t.length){e.innerHTML='<span class="label">\u5C1A\u7121\u7D00\u9304</span>';return}e.innerHTML=t.map(n=>`<span class="chip-btn" data-name="${n.name}">${n.name}<button class="chip-del" type="button" aria-label="\u522A\u9664" data-del="${n.name}">\xD7</button></span>`).join("")}function A(e){let t=m(e);if(!t)return[];let n=v.map(a=>{let o=m(a.name),s=a.town?m(a.town):"",c=a.county?m(a.county):"",u=(o.startsWith(t)?3:0)+(o.includes(t)?2:0)+(s&&s.startsWith(t)?2:0)+(s&&s.includes(t)?1:0)+(c&&c.startsWith(t)?1:0);return{p:a,score:u}}).filter(a=>a.score>0);return n.sort((a,o)=>o.score-a.score||a.p.name.localeCompare(o.p.name)),n.map(a=>a.p).slice(0,8)}function b(e){return e.town&&e.county?`${e.county}${e.town}`:e.name}function W(e){let t=i("suggestions");if(!e.length){t.style.display="none",t.innerHTML="";return}t.innerHTML=e.map(n=>{let a=b(n),o=n.town&&n.county?`<span class="suggest-meta">${n.county}</span>`:"";return`<button type="button" data-place="${a}">${a}${o}</button>`}).join(""),t.style.display="block"}i("placeSearch").addEventListener("input",e=>{let t=e.target,n=A(t.value);W(n)});i("placeSearch").addEventListener("focus",e=>{let t=e.target,n=A(t.value);W(n)});document.addEventListener("click",e=>{let t=e.target;!t.closest("#placeSearch")&&!t.closest("#suggestions")&&(i("suggestions").style.display="none")});i("suggestions").addEventListener("click",e=>{let n=e.target.closest("button[data-place]");if(!n)return;let a=n.getAttribute("data-place")||"",o=S(a)||v.find(s=>b(s)===a);o&&(i("placeSearch").value=b(o),i("suggestions").style.display="none",$(o))});i("searchForm").addEventListener("submit",e=>{e.preventDefault();let t=i("placeSearch").value.trim(),n=S(t)||A(t)[0];if(!n)return alert("\u627E\u4E0D\u5230\u8A72\u7E23\u5E02\uFF0C\u8ACB\u6539\u7528\u5176\u4ED6\u95DC\u9375\u5B57\u3002");i("placeSearch").value=b(n),$(n)});i("btnGeo").onclick=()=>{if(!navigator.geolocation)return alert("\u6B64\u700F\u89BD\u5668\u4E0D\u652F\u63F4\u5B9A\u4F4D");navigator.geolocation.getCurrentPosition(e=>{let t=Number(e.coords.latitude.toFixed(6)),n=Number(e.coords.longitude.toFixed(6)),a={name:"\u76EE\u524D\u4F4D\u7F6E",lat:t,lon:n};H(t,n,a.name),B(a),h(),r=a,p(t,n,g).catch(o=>d({ok:!1,error:String(o),date:"",periods:[]}))},e=>alert("\u5B9A\u4F4D\u5931\u6557\uFF1A"+e.message),{enableHighAccuracy:!1,timeout:1e4,maximumAge:6e4})};i("quickPlaces").addEventListener("click",e=>{let n=e.target.closest("button[data-place]");if(!n)return;let a=n.getAttribute("data-place")||"",o=S(a);o&&$(o)});i("recentPlaces").addEventListener("click",e=>{let t=e.target,n=t.closest("button[data-del]");if(n){q(n.getAttribute("data-del")||"");return}let a=t.closest("span[data-name]");if(a){let o=a.getAttribute("data-name")||"",s=S(o)||w().find(c=>c.name===o)||null;s&&$(s)}});function le(){let e=["\u53F0\u5317\u5E02","\u53F0\u4E2D\u5E02","\u9AD8\u96C4\u5E02"];i("quickPlaces").innerHTML=e.map(t=>`<button class="chip-btn" type="button" data-place="${t}">${t}</button>`).join("")}function k(e){let t=document.documentElement;e==="dark"||e==="light"?(t.setAttribute("data-theme",e),localStorage.setItem(M,e)):(t.removeAttribute("data-theme"),localStorage.removeItem(M))}function se(){let e=localStorage.getItem(M);k(e==="dark"?"light":"dark")}async function ce(){try{let e=await fetch("/data/townships.json",{cache:"force-cache"});if(!e.ok)return;let t=await e.json();Array.isArray(t)&&t.length&&(v=[...Y,...t.map(n=>({name:n.name,county:n.county,town:n.town,lat:n.lat,lon:n.lon,type:n.type}))])}catch(e){}}var y=i("settingsPanel"),ue=i("settingsToggle"),me=i("closeSettings"),de=i("resetBias"),C=i("morningBias"),N=i("eveningBias"),O=i("morningBiasValue"),J=i("eveningBiasValue");function ge(){y.classList.add("active"),y.setAttribute("aria-hidden","false")}function K(){y.classList.remove("active"),y.setAttribute("aria-hidden","true")}function G(){let e=V();C.value=String(e.morning),N.value=String(e.evening),O.textContent=e.morning.toFixed(1),J.textContent=e.evening.toFixed(1)}function Z(){let e=Number(C.value),t=Number(N.value);localStorage.setItem(I,String(e)),localStorage.setItem(P,String(t)),O.textContent=e.toFixed(1),J.textContent=t.toFixed(1),r&&p(r.lat,r.lon,g).catch(n=>d({ok:!1,error:String(n),date:"",periods:[]}))}function Q(e){return e.rain===!0?ve():e.rain===!1?fe():pe()}function X(e){let t=String(e||"");return t.includes("\u7FBD\u7D68")||t.includes("\u539A\u5916\u5957")?Te():t.includes("\u8584\u5916\u5957")||t.includes("\u5916\u5957")?Ee():t.includes("\u6BDB\u8863")||t.includes("\u4FDD\u6696")?Le():t.includes("\u9577\u8896")?he():t.includes("\u77ED\u8896")||t.includes("\u80CC\u5FC3")?ye():Me()}function fe(){return'<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="4"/><path d="M12 3v2M12 19v2M3 12h2M19 12h2M5.3 5.3l1.4 1.4M17.3 17.3l1.4 1.4M18.7 5.3l-1.4 1.4M6.7 17.3l-1.4 1.4"/></svg>'}function pe(){return'<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 18h9a4 4 0 0 0 0-8 5 5 0 0 0-9-1A4 4 0 0 0 7 18z"/></svg>'}function ve(){return'<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 14h9a4 4 0 0 0 0-8 5 5 0 0 0-9-1A4 4 0 0 0 7 14z"/><path d="M9 17l-1 2M12 17l-1 2M15 17l-1 2"/></svg>'}function ye(){return'<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5l2-2h4l2 2 3 2-2 3-2-1v9H9v-9l-2 1-2-3 3-2z"/></svg>'}function he(){return'<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 5l2-2h6l2 2 3 2-2 4-2-1v9H8v-9l-2 1-2-4 3-2z"/></svg>'}function Le(){return'<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5l2-2h4l2 2 3 2-1.5 3.5-2-1v9H8v-9l-2 1L4.5 7 8 5z"/></svg>'}function Ee(){return'<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 4l2-2h4l2 2 3 2-2 3-2-1v11H9V8L7 9 5 6l3-2z"/></svg>'}function Te(){return'<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 3l2-1h4l2 1 2 3-2 2-1-1v14H9V7L8 8 6 6l2-3z"/></svg>'}function Me(){return'<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 4l8 5-8 5-8-5 8-5zm0 7l8 5-8 5-8-5 8-5z"/></svg>'}function be(){let e=0,t=!1,n=70;window.addEventListener("touchstart",a=>{window.scrollY===0&&(e=a.touches[0].clientY,t=!0)},{passive:!0}),window.addEventListener("touchmove",a=>{if(!t)return;a.touches[0].clientY-e>n&&(t=!1,location.reload())},{passive:!0}),window.addEventListener("touchend",()=>{t=!1},{passive:!0})}le();h();ce();var x=localStorage.getItem(M);x&&k(x);var He=i("themeToggle");He.addEventListener("click",se);ue.addEventListener("click",ge);me.addEventListener("click",K);y.addEventListener("click",e=>{e.target===y&&K()});C.addEventListener("input",Z);N.addEventListener("input",Z);de.addEventListener("click",()=>{localStorage.removeItem(I),localStorage.removeItem(P),G(),r&&p(r.lat,r.lon,g).catch(e=>d({ok:!1,error:String(e),date:"",periods:[]}))});G();var ee=new URLSearchParams(location.search),_=ee.get("lat"),z=ee.get("lon");if(_&&z){let e={name:"",lat:Number(_),lon:Number(z)};r=e,H(e.lat,e.lon,e.name),p(e.lat,e.lon,g).catch(t=>d({ok:!1,error:String(t),date:"",periods:[]}))}else{let e=ae();e&&e.lat&&e.lon&&(r={name:e.name||"",lat:e.lat,lon:e.lon},p(e.lat,e.lon,g).catch(t=>d({ok:!1,error:String(t),date:"",periods:[]})),e.name&&(i("placeSearch").value=e.name))}i("dayTabs").addEventListener("click",e=>{let n=e.target.closest("button[data-day]");if(!n)return;let a=Number(n.getAttribute("data-day"));Number.isFinite(a)&&(g=a,i("dayTabs").querySelectorAll(".tab").forEach(o=>o.classList.remove("active")),n.classList.add("active"),r&&p(r.lat,r.lon,g).catch(o=>d({ok:!1,error:String(o),date:"",periods:[]})))});"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").catch(()=>{});be();})();
